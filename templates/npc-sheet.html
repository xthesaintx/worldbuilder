<div class="campaign-codex npc-sheet">

  <div class="sheet-body">
    {{!-- Sidebar Navigation --}}
    <nav class="sidebar">
      <div class="sidebar-header">
        <div class="location-image">
          {{#if linkedActor}}
            <img src="{{linkedActor.img}}" alt="{{linkedActor.name}}" onerror="this.src='icons/svg/mystery-man.svg'">
          {{else}}
            <img src="{{document.img}}" alt="{{document.name}}" onerror="this.src='icons/svg/mystery-man.svg'">
          {{/if}}
        </div>
        <button class="image-change-btn" type="button">
          <i class="fas fa-camera"></i> Change Image
        </button>
        
        {{#if linkedActor}}
          <div class="actor-stats">
            <div class="stat-row">
              <span class="stat-label">Level {{linkedActor.level}} {{linkedActor.race}} {{linkedActor.class}}</span>
            </div>
            <div class="stat-row">
              <span class="stat-value">AC {{linkedActor.ac}}</span>
              <span class="stat-value">HP {{linkedActor.hp.value}}/{{linkedActor.hp.max}}</span>
            </div>
          </div>
        {{else}}
          <div class="character-preview">
            {{#if npcData.race}}
              <div class="preview-line">{{npcData.race}}</div>
            {{/if}}
            {{#if npcData.alignment}}
              <div class="preview-line">{{npcData.alignment}}</div>
            {{/if}}
          </div>
        {{/if}}
      </div>
      
      <ul class="sidebar-tabs">
        <li class="tab-item {{#if (eq currentTab 'info')}}active{{/if}}" data-tab="info">
          <i class="fas fa-info-circle"></i>
          <span>Info</span>
        </li>
        <li class="tab-item {{#if (eq currentTab 'skills')}}active{{/if}}" data-tab="skills">
          <i class="fas fa-tools"></i>
          <span>Skills</span>
        </li>
        <li class="tab-item {{#if (eq currentTab 'personality')}}active{{/if}}" data-tab="personality">
          <i class="fas fa-heart"></i>
          <span>Traits</span>
        </li>
        <li class="tab-item {{#if (eq currentTab 'locations')}}active{{/if}}" data-tab="locations">
          <i class="fas fa-map-marker-alt"></i>
          <span>Locations</span>
        </li>
        <li class="tab-item {{#if (eq currentTab 'shops')}}active{{/if}}" data-tab="shops">
          <i class="fas fa-store"></i>
          <span>Shops</span>
        </li>
        <li class="tab-item {{#if (eq currentTab 'associates')}}active{{/if}}" data-tab="associates">
          <i class="fas fa-users"></i>
          <span>Associates</span>
        </li>
        <li class="tab-item {{#if (eq currentTab 'notes')}}active{{/if}}" data-tab="notes">
          <i class="fas fa-sticky-note"></i>
          <span>Notes</span>
        </li>
      </ul>

      {{!-- Links Section --}}
      <div class="sidebar-links">
        <h3>Quick Links</h3>
        <div class="link-grid">
          {{#each linkedLocations}}
            <div class="link-card location-link" data-location-id="{{id}}">
              <img src="{{img}}" alt="{{name}}">
              <span class="link-name">{{name}}</span>
            </div>
          {{/each}}
          {{#each linkedShops}}
            <div class="link-card shop-link" data-shop-id="{{id}}">
              <img src="{{img}}" alt="{{name}}">
              <span class="link-name">{{name}}</span>
            </div>
          {{/each}}
          {{#each associates}}
            <div class="link-card npc-link" data-npc-id="{{id}}">
              <img src="{{img}}" alt="{{name}}">
              <span class="link-name">{{name}}</span>
            </div>
          {{/each}}
        </div>
      </div>
    </nav>

    {{!-- Main Content Area --}}
    <main class="main-content">
      <form class="npc-form">
        
        {{!-- Info Tab --}}
        <section class="tab-panel {{#if (eq currentTab 'info')}}active{{/if}}" data-tab="info">
          <div class="content-header">
            <h2><i class="fas fa-info-circle"></i> Character Information</h2>
          </div>

          {{!-- Character Name --}}
          <div class="form-section">
            <label class="form-label">
              <i class="fas fa-user"></i>
              Character Name
            </label>
            <input name="name" class="form-input" type="text" value="{{npcData.name}}" placeholder="Character name..." />
          </div>

          {{!-- Simplified NPC Stats --}}
          <div class="npc-stats-section">
            <h3><i class="fas fa-user"></i> Core Stats</h3>
            <div class="npc-grid">
              <div class="form-group">
                <label class="form-label">Race/Species</label>
                <input name="race" class="form-input" type="text" value="{{npcData.race}}" placeholder="Human, Elf, etc..." />
              </div>
              <div class="form-group">
                <label class="form-label">Alignment</label>
                <select name="alignment" class="form-input">
                  <option value="">Choose alignment...</option>
                  <option value="Lawful Good" {{#if (eq npcData.alignment "Lawful Good")}}selected{{/if}}>Lawful Good</option>
                  <option value="Neutral Good" {{#if (eq npcData.alignment "Neutral Good")}}selected{{/if}}>Neutral Good</option>
                  <option value="Chaotic Good" {{#if (eq npcData.alignment "Chaotic Good")}}selected{{/if}}>Chaotic Good</option>
                  <option value="Lawful Neutral" {{#if (eq npcData.alignment "Lawful Neutral")}}selected{{/if}}>Lawful Neutral</option>
                  <option value="True Neutral" {{#if (eq npcData.alignment "True Neutral")}}selected{{/if}}>True Neutral</option>
                  <option value="Chaotic Neutral" {{#if (eq npcData.alignment "Chaotic Neutral")}}selected{{/if}}>Chaotic Neutral</option>
                  <option value="Lawful Evil" {{#if (eq npcData.alignment "Lawful Evil")}}selected{{/if}}>Lawful Evil</option>
                  <option value="Neutral Evil" {{#if (eq npcData.alignment "Neutral Evil")}}selected{{/if}}>Neutral Evil</option>
                  <option value="Chaotic Evil" {{#if (eq npcData.alignment "Chaotic Evil")}}selected{{/if}}>Chaotic Evil</option>
                </select>
              </div>
            </div>
          </div>

          {{!-- Core Ability Scores Only --}}
          <div class="ability-scores-section">
            <h3><i class="fas fa-dice-d20"></i> Ability Scores</h3>
            <div class="abilities-grid">
              {{#each npcData.abilities as |value key|}}
                <div class="ability-block">
                  <div class="ability-name">{{key}}</div>
                  <div class="ability-controls">
                    <input type="number" class="ability-input" data-ability="{{key}}" name="{{key}}" value="{{value}}" min="1" max="20" />
                    <button type="button" class="ability-roll" data-ability="{{key}}" title="Roll 4d6 drop lowest">
                      <i class="fas fa-dice"></i>
                    </button>
                  </div>
                  <div class="ability-modifier">
                    {{#if (lookup ../npcData.abilityMods key)}}
                      {{#if (gt (lookup ../npcData.abilityMods key) 0)}}+{{/if}}{{lookup ../npcData.abilityMods key}}
                    {{else}}
                      +0
                    {{/if}}
                  </div>
                </div>
              {{/each}}
            </div>
          </div>

          {{!-- Description Section --}}
          <div class="form-section">
            <label class="form-label">
              <i class="fas fa-align-left"></i>
              Description
            </label>
            <textarea name="description" class="form-textarea" rows="6" placeholder="Physical description, mannerisms, etc...">{{npcData.description}}</textarea>
          </div>

          {{!-- Notes Section --}}
          <div class="form-section">
            <label class="form-label">
              <i class="fas fa-sticky-note"></i>
              Notes
            </label>
            <textarea name="notes" class="form-textarea" rows="6" placeholder="Character notes, personality, goals, etc...">{{npcData.notes}}</textarea>
          </div>

          {{!-- Optional Actor Link (Compact) --}}
          {{#if linkedActor}}
            <div class="form-section">
              <label class="form-label">
                <i class="fas fa-link"></i>
                Linked Actor
              </label>
              <div class="linked-actor-compact">
                <img src="{{linkedActor.img}}" alt="{{linkedActor.name}}" class="actor-avatar">
                <span class="actor-name">{{linkedActor.name}}</span>
                <button type="button" class="action-btn open-actor" data-actor-id="{{linkedActor.id}}" title="Open Actor Sheet">
                  <i class="fas fa-external-link-alt"></i>
                </button>
                <button type="button" class="action-btn remove-actor" title="Unlink Actor">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          {{/if}}
        </section>

        {{!-- Skills & Equipment Tab --}}
        <section class="tab-panel {{#if (eq currentTab 'skills')}}active{{/if}}" data-tab="skills">
          <div class="content-header">
            <h2><i class="fas fa-tools"></i> Skills & Equipment</h2>
          </div>

          {{!-- Skills Section --}}
          <div class="skills-section">
            <h3><i class="fas fa-star"></i> Proficient Skills</h3>
            <div class="skills-list">
              {{#each npcData.skills}}
                <div class="skill-item">
                  <span class="skill-name">{{this}}</span>
                  <button type="button" class="remove-skill" data-skill="{{this}}" title="Remove skill">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              {{/each}}
            </div>
            <button type="button" class="add-skill btn-secondary">
              <i class="fas fa-plus"></i> Add Skill
            </button>
          </div>

          {{!-- Languages Section --}}
          <div class="languages-section">
            <h3><i class="fas fa-language"></i> Languages</h3>
            <div class="languages-list">
              {{#each npcData.languages}}
                <div class="language-item">
                  <span class="language-name">{{this}}</span>
                  <button type="button" class="remove-language" data-language="{{this}}" title="Remove language">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              {{/each}}
            </div>
            <button type="button" class="add-language btn-secondary">
              <i class="fas fa-plus"></i> Add Language
            </button>
          </div>

          {{!-- Equipment Section --}}
          <div class="equipment-section">
            <h3><i class="fas fa-sword"></i> Equipment & Inventory</h3>
            <div class="equipment-list">
              {{#each npcData.equipment}}
                <div class="equipment-item">
                  <div class="equipment-info">
                    <span class="equipment-name">{{name}}</span>
                    <span class="equipment-type">{{type}}</span>
                    <span class="equipment-quantity">Ã—{{quantity}}</span>
                  </div>
                  <button type="button" class="remove-equipment" data-index="{{@index}}" title="Remove equipment">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              {{/each}}
            </div>
            <button type="button" class="add-equipment btn-secondary">
              <i class="fas fa-plus"></i> Add Equipment
            </button>
          </div>
        </section>

        {{!-- Personality Tab --}}
        <section class="tab-panel {{#if (eq currentTab 'personality')}}active{{/if}}" data-tab="personality">
          <div class="content-header">
            <h2><i class="fas fa-heart"></i> Personality & Traits</h2>
          </div>

          <div class="personality-grid">
            <div class="form-section">
              <label class="form-label">
                <i class="fas fa-smile"></i>
                Personality Traits
              </label>
              <textarea name="personality" class="form-textarea" rows="4" placeholder="How does this character act and speak?">{{npcData.personality}}</textarea>
            </div>

            <div class="form-section">
              <label class="form-label">
                <i class="fas fa-lightbulb"></i>
                Ideals
              </label>
              <textarea name="ideals" class="form-textarea" rows="4" placeholder="What drives this character?">{{npcData.ideals}}</textarea>
            </div>

            <div class="form-section">
              <label class="form-label">
                <i class="fas fa-handshake"></i>
                Bonds
              </label>
              <textarea name="bonds" class="form-textarea" rows="4" placeholder="What connects this character to the world?">{{npcData.bonds}}</textarea>
            </div>

            <div class="form-section">
              <label class="form-label">
                <i class="fas fa-exclamation-triangle"></i>
                Flaws
              </label>
              <textarea name="flaws" class="form-textarea" rows="4" placeholder="What are this character's weaknesses?">{{npcData.flaws}}</textarea>
            </div>
          </div>
        </section>

        {{!-- Locations Tab --}}
        <section class="tab-panel {{#if (eq currentTab 'locations')}}active{{/if}}" data-tab="locations">
          <div class="content-header">
            <h2><i class="fas fa-map-marker-alt"></i> Locations</h2>
          </div>
          
          <div class="drop-zone" data-drop-type="location">
            <div class="drop-content">
              <i class="fas fa-map-marker-alt"></i>
              <h3>Add Locations</h3>
              <p>Drag location journals here</p>
            </div>
          </div>

          {{#if linkedLocations}}
            <div class="entity-grid">
              {{#each linkedLocations}}
                <div class="entity-card location-card">
                  <div class="entity-image">
                    <img src="{{img}}" alt="{{name}}">
                  </div>
                  <div class="entity-content">
                    <h4 class="entity-name">{{name}}</h4>
                    <div class="entity-meta">
                      <span class="entity-type">Location</span>
                    </div>
                  </div>
                  <div class="entity-actions">
                    <button type="button" class="action-btn open-location" data-location-id="{{id}}" title="Open Location">
                      <i class="fas fa-external-link-alt"></i>
                    </button>
                    <button type="button" class="action-btn remove-location" data-location-id="{{id}}" title="Remove from NPC">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              {{/each}}
            </div>
          {{else}}
            <div class="empty-state">
              <i class="fas fa-map-marker-alt"></i>
              <h3>No Locations</h3>
              <p>Drag location journals here to show where this NPC can be found</p>
            </div>
          {{/if}}
        </section>

        {{!-- Shops Tab --}}
        <section class="tab-panel {{#if (eq currentTab 'shops')}}active{{/if}}" data-tab="shops">
          <div class="content-header">
            <h2><i class="fas fa-store"></i> Associated Shops</h2>
          </div>
          
          <div class="drop-zone" data-drop-type="shop">
            <div class="drop-content">
              <i class="fas fa-store"></i>
              <h3>Add Shops</h3>
              <p>Drag shop journals here</p>
            </div>
          </div>

          {{#if linkedShops}}
            <div class="entity-grid">
              {{#each linkedShops}}
                <div class="entity-card shop-card">
                  <div class="entity-image">
                    <img src="{{img}}" alt="{{name}}">
                  </div>
                  <div class="entity-content">
                    <h4 class="entity-name">{{name}}</h4>
                    <div class="entity-meta">
                      <span class="entity-type">Shop</span>
                    </div>
                  </div>
                  <div class="entity-actions">
                    <button type="button" class="action-btn open-shop" data-shop-id="{{id}}" title="Open Shop">
                      <i class="fas fa-external-link-alt"></i>
                    </button>
                    <button type="button" class="action-btn remove-shop" data-shop-id="{{id}}" title="Remove from NPC">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              {{/each}}
            </div>
          {{else}}
            <div class="empty-state">
              <i class="fas fa-store"></i>
              <h3>No Shops</h3>
              <p>Drag shop journals here to show what businesses this NPC is associated with</p>
            </div>
          {{/if}}
        </section>

        {{!-- Associates Tab --}}
        <section class="tab-panel {{#if (eq currentTab 'associates')}}active{{/if}}" data-tab="associates">
          <div class="content-header">
            <h2><i class="fas fa-users"></i> Associates & Contacts</h2>
          </div>
          
          <div class="drop-zone" data-drop-type="associate">
            <div class="drop-content">
              <i class="fas fa-user-friends"></i>
              <h3>Add Associates</h3>
              <p>Drag NPC journals or actors here</p>
            </div>
          </div>

          {{#if associates}}
            <div class="entity-grid">
              {{#each associates}}
                <div class="entity-card npc-card">
                  <div class="entity-image">
                    <img src="{{img}}" alt="{{name}}">
                  </div>
                  <div class="entity-content">
                    <h4 class="entity-name">{{name}}</h4>
                    {{#if actor}}
                      <div class="entity-meta">
                        <span class="entity-type">{{actor.system.details.race}} {{actor.system.details.class}}</span>
                      </div>
                    {{else}}
                      <div class="entity-meta">
                        <span class="entity-type">NPC</span>
                      </div>
                    {{/if}}
                  </div>
                  <div class="entity-actions">
                    <button type="button" class="action-btn open-associate" data-associate-id="{{id}}" title="Open NPC Journal">
                      <i class="fas fa-book-open"></i>
                    </button>
                    {{#if actor}}
                      <button type="button" class="action-btn open-actor" data-actor-id="{{actor.id}}" title="Open Actor Sheet">
                        <i class="fas fa-user"></i>
                      </button>
                    {{/if}}
                    <button type="button" class="action-btn remove-associate" data-associate-id="{{id}}" title="Remove Association">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              {{/each}}
            </div>
          {{else}}
            <div class="empty-state">
              <i class="fas fa-users"></i>
              <h3>No Associates</h3>
              <p>Drag other NPCs here to create relationships and connections</p>
            </div>
          {{/if}}
        </section>

        {{!-- Notes Tab --}}
        <section class="tab-panel {{#if (eq currentTab 'notes')}}active{{/if}}" data-tab="notes">
          <div class="content-header">
            <h2><i class="fas fa-sticky-note"></i> GM Notes</h2>
          </div>
          
          <div class="form-section">
            <label class="form-label">
              <i class="fas fa-eye-slash"></i>
              Private Notes
            </label>
            <textarea name="notes" class="form-textarea" rows="12" placeholder="Private GM notes about this NPC...">{{npcData.notes}}</textarea>
          </div>
        </section>

      </form>
    </main>
  </div>

</div>